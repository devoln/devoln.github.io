<html>

<head>
<meta charset="utf-8">

<style>
.spoiler > input + label:after{content: "+";float: right;font-family: monospace;font-weight: bold;}
.spoiler > input:checked + label:after{content: "-";float: right;font-family: monospace;font-weight: bold;}
.spoiler > input{display:none;}
.spoiler > input + label , .spoiler > .spoiler_body{background:#CCC;padding:5px 15px;width:100%;box-sizing: border-box;display: block;}
.spoiler > input + label + .spoiler_body{display:none;}
.spoiler > input:checked + label + .spoiler_body{display: block;}
.spoiler > .spoiler_body{background: #FFF;border: 3px solid #CCC;border-top: none;}
</style>

</head>

<body>


<noscript><font size=4 color=red><b>Для работы приложения включите JavaScript в браузере!</b></font></noscript>

<p><label>Q: </label><br/><textarea cols="100" rows="5" id="SequenceQ" autocorrect="off" style="width:100%" value=""></textarea></p>
<p><label>S: </label><br/><textarea cols="100" rows="5" id="SequenceS" autocorrect="off" style="width:100%" value=""></textarea></p>
<p><label>d = </label><input type="number" step="any" id="GapPenalty" autocorrect="off" cols="5" value="100" min="0" max="1000000"></p>
<p><label>Матрица замен </label><input type="text" step="any" id="ZName" autocorrect="off" cols="5" value="Z"></p>

<p><button id="align" style="height:48px;width:256px;font-size: 18px" onclick="Align()">Построить выравнивание</button></p>

<hr>
<nobr>
<pre id="Alignment">
</nobr>
</pre>
<hr>

<div class="spoiler">
<input type="checkbox" id="spoilerid_1" checked><label for="spoilerid_1">
Матрицы динамического программирования
</label><div class="spoiler_body" id="DynProgMatrices">
</div></div>

<br/>

<div class="spoiler">
<input type="checkbox" id="spoilerid_2" checked><label for="spoilerid_2">
Процедура обратного прохода
</label><div class="spoiler_body">
<pre id="TracebackOutput">
</pre>
</div></div>

<script type="text/javascript">
	var gScript = document.createElement('script');
	gScript.src = "SeqLib.js"
	document.body.appendChild(gScript);
	gScript.loaded = false;
	
	var entityMap = {
	  "&": "&amp;",
	  "<": "&lt;",
	  ">": "&gt;",
	  '"': '&quot;',
	  "'": '&#39;',
	  "/": '&#x2F;'
	};

	function escapeHtml(string)
	{
	  return String(string).replace(/[&<>"'\/]/g, function (s)
	  {
		return entityMap[s];
	  }).replace(/\r\n/g, "<br/>").replace(/\n/g, "<br/>").replace(/\r/g, "<br/>");
	}
	
	var gAutoAlign = false;
	gScript.onload = function()
	{
		gScript.loaded = true;
		if(gAutoAlign) Align();
	}
	
	function getParameterByName(name, url)
	{
		if(!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
		var results = regex.exec(url);
		if(!results) return null;
		if(!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
	
	if(location.search)
	{
		var qseq = getParameterByName("qseq");
		document.getElementById('SequenceQ').value = qseq==null? "": qseq;
		var sseq = getParameterByName("sseq");
		document.getElementById('SequenceS').value = sseq==null? "": sseq;
		var d = parseFloat(getParameterByName("d"));
		if(getParameterByName("auto")!=null) gAutoAlign = true;

		if(!isNaN(d)) document.getElementById('GapPenalty').value = d.toString();
	}
	
	function RemoveNonSeqChars(str)
	{
		return str.replace(/\s/g, '').replace(/-/g, '');
	}
	
	function Align()
	{
		if(!gScript.loaded)
		{
			gAutoAlign = true;
			return;
		}
	
		var srcQ = RemoveNonSeqChars(document.getElementById('SequenceQ').value).toUpperCase();
		var srcS = RemoveNonSeqChars(document.getElementById('SequenceS').value).toUpperCase();
		var zName = document.getElementById('ZName').value;
		var d = parseFloat(document.getElementById('GapPenalty').value);
		if(isNaN(d)) d = 100;
		
		var srcQPtr = Module._malloc(srcQ.length*2);
		stringToUTF8(srcQ, srcQPtr, srcQ.length*2);
		var srcSPtr = Module._malloc(srcS.length*2);
		stringToUTF8(srcS, srcSPtr, srcS.length*2);
		var zNamePtr = Module._malloc((zName.length+4)*2);
		stringToUTF8(zName+".bin", zNamePtr, (zName.length+4)*2);
		var resultsPtr = Module._SeqLibC_PairAlign(srcQPtr, srcSPtr, zNamePtr, d, true, true);
		Module._free(zNamePtr);
		Module._free(srcSPtr);
		Module._free(srcQPtr);
		
		var score = Module.HEAPF32[resultsPtr/4];
		var alignmentQ = Pointer_stringify(Module.HEAPU32[resultsPtr/4+1]);
		var alignmentS = Pointer_stringify(Module.HEAPU32[resultsPtr/4+2]);
		var matricesOutput = Pointer_stringify(Module.HEAPU32[resultsPtr/4+3]);
		var tracebackOutput = Pointer_stringify(Module.HEAPU32[resultsPtr/4+4]);
		Module._SeqLibC_PairAlignCleanUp(resultsPtr);
		
		document.getElementById('Alignment').innerHTML = alignmentQ+'<br/>'+alignmentS+'<br/>'+"Вес = "+(Math.round(score*100)/100).toString();
		document.getElementById('DynProgMatrices').innerHTML = matricesOutput;
		document.getElementById('TracebackOutput').innerHTML = tracebackOutput;
	}
</script>

</body>

</html>
